<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <title>Admin Projets</title>
  <style>
    body {
      background-color: #121212;
      color: #fff;
      font-family: sans-serif;
      margin: 0;
      padding: 20px;
    }
    .nav-admin {
    background: #222;
    padding: 10px;
    display: flex;
    gap: 15px;
  }

  .nav-admin a {
    color: #fff;
    text-decoration: none;
    font-weight: bold;
    padding: 6px 12px;
    border-radius: 4px;
  }

  .nav-admin a:hover {
    background: orange;
    color: black;
  }

    h1 {
      color: orange;
    }

    .projet {
      border-left: 4px solid orange;
      background: #1e1e1e;
      padding: 10px;
      margin-bottom: 20px;
    }

    .projet h3 {
      margin: 0;
    }

    form {
      background: #1e1e1e;
      padding: 20px;
      margin-top: 40px;
      border: 1px solid #333;
    }

    input, textarea {
      width: 100%;
      margin-bottom: 10px;
      padding: 10px;
      background: #333;
      color: white;
      border: none;
    }

    button {
      padding: 10px 20px;
      background: orange;
      border: none;
      color: #000;
      cursor: pointer;
      margin-right: 10px;
    }
  </style>
</head>
<body>
  <nav class="nav-admin">
  <a href="https://muthekekambalesaid-beep.github.io/said/">Accueil</a>
  <a href="https://muthekekambalesaid-beep.github.io/said/said/set/mutheke/saidSetPortfolio.html">Portfolio</a>
  <a href="https://muthekekambalesaid-beep.github.io/said/said/set/mutheke/saidSetProjects.html">Projets</a>
  <a href="https://muthekekambalesaid-beep.github.io/said/said/set/mutheke/saidSetMessages.html">Messages</a>
  </nav>
  <h1>Gestion des Projets</h1>

  <div id="liste-projets">Chargement...</div>

  <form id="form-projet">
  <input type="hidden" id="docId">
    <input type="text" maxLength="100" id="titre" placeholder="Titre" required>
    <textarea id="synopsis" maxLength="600" placeholder="Synopsis" required></textarea>
    <input type="text" maxLength="150" id="note" placeholder="Note (ex: Projet sensible)">
    <button type="submit">Enregistrer</button>
    <button type="button" onclick="resetForm()">Annuler</button>
  </form>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
    import { getFirestore, collection, addDoc, updateDoc, deleteDoc, doc, onSnapshot } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDh1MNL0RYp8Dk-UoDoqf0sSdS84AhRXHk",
      authDomain: "said-mutheke.firebaseapp.com",
      projectId: "said-mutheke",
      storageBucket: "said-mutheke.appspot.com",
      messagingSenderId: "378853548599",
      appId: "1:378853548599:web:701a11d4f8a9cd6b1d95b2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth();
    
    onAuthStateChanged(auth, async (user) => {
  if (!user) {
    window.location.href = "404.html";
    return;
  }

  const setDocRef = doc(db, "set", user.uid);
  const setDocSnap = await getDoc(setDocRef);

  if (!setDocSnap.exists()) {
    window.location.href = "404.html";
  }
});
    
    
    const colRef = collection(db, "projects");

    const liste = document.getElementById("liste-projets");
    const form = document.getElementById("form-projet");

    const titre = document.getElementById("titre");
    const synopsis = document.getElementById("synopsis");
    const note = document.getElementById("note");
    const docId = document.getElementById("docId");

    onSnapshot(colRef, (snapshot) => {
      liste.innerHTML = "";
      snapshot.forEach(docSnap => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "projet";
        div.innerHTML = `
          <h3>${data.titre}</h3>
          <p>${data.synopsis}</p>
          <p><strong>Note:</strong> ${data.note || "â€“"}</p>
          <p><em>${data.date ? new Date(data.date.seconds * 1000).toLocaleDateString() : ""}</em></p>
          <button 
    class="modifier-btn" 
    data-id="${docSnap.id}" 
    data-titre="${encodeURIComponent(data.titre)}" 
    data-synopsis="${encodeURIComponent(data.synopsis)}" 
    data-note="${encodeURIComponent(data.note || "")}">Modifier </button>
          <button onclick="supprimer('${docSnap.id}')">Supprimer</button>
        `;
        liste.appendChild(div);
      });
    });

    form.addEventListener("submit", async (e) => {
      e.preventDefault();

      const data = {
        titre: titre.value,
        synopsis: synopsis.value,
        note: note.value,
        date: new Date()
      };

      if (docId.value) {
        const ref = doc(db, "projects", docId.value);
        await updateDoc(ref, data);
      } else {
        await addDoc(colRef, data);
      }
      resetForm();
    });

    document.addEventListener("click", (e) => {
  if (e.target.classList.contains("modifier-btn")) {
    const btn = e.target;
    const id = btn.dataset.id;
    const titre = decodeURIComponent(btn.dataset.titre);
    const synopsis = decodeURIComponent(btn.dataset.synopsis);
    const note = decodeURIComponent(btn.dataset.note);

    modifier(id, titre, synopsis, note);
  }
});

    window.modifier = (id, t, s, n) => {
      docId.value = id;
      titre.value = t;
      synopsis.value = s;
      note.value = n;
      window.scrollTo(0, 0);
    };

    window.supprimer = async (id) => {
      if (confirm("Supprimer ce projet ?")) {
        await deleteDoc(doc(db, "projects", id));
      }
    };

    window.resetForm = () => {
      docId.value = "";
      titre.value = "";
      synopsis.value = "";
      note.value = "";
    };
  </script>

</body>
</html>
